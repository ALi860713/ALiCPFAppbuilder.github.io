<!DOCTYPE html>
<head>
<title>CPF倉儲系統</title>
<link rel="stylesheet" href="style.css">

</head>
<body>

<div class="container">

<table id="list">
	<tr>
		<td id="parent">
			<div class="item" id="cpf" onclick="changeItem('cpf',1)">
				<div class="itemname">雲教授</div>
				<img class="itemimg" src="./images/cpf.png" style="margin-top: 5px; width: 45%;" />
				<span id="cpf_count" class="itemcount">x 1</span>
			</div>
			<div class="item" onclick="changeItem('abs',3)">
				<div class="itemname">Digital Signage</div>
				<img class="itemimg" src="./images/acer_abs.png" />
				<span id="abs_count" class="itemcount">x 1</span>
			</div>
			<div class="item" onclick="changeItem('egg',5)">
				<div class="itemname">彩蛋</div>
				<img class="itemimg" src="./images/egg.png" style="width: 30%; margin-top: 5px;" />
				<span id="egg_count" class="itemcount">x 3</span>
			</div>
			<div class="item" onclick="changeItem('nb',7)">
				<div class="itemname">筆記型電腦</div>
				<img class="itemimg" src="./images/acer_laptop.png" style="margin-top: 5px; width: 45%;" />
				<span id="nb_count" class="itemcount">x 3</span>
			</div>
			<div class="item" onclick="changeItem('lcd',9)">
				<div class="itemname">顯示器</div>
				<img class="itemimg" src="./images/acer_screen.png" />
				<span id="lcd_count" class="itemcount">x 3</span>
			</div>
			<div class="item" onclick="changeItem('pc',11)">
				<div class="itemname">桌上型電腦</div>
				<img class="itemimg" src="./images/acer_desktop.png" style="margin-top: -5px;" />
				<span id="pc_count" class="itemcount">x 3</span>
			</div>
			<div class="item" onclick="changeItem('pj',13)">
				<div class="itemname">投影機</div>
				<img class="itemimg" src="./images/acer_projector.png" />
				<span id="pj_count" class="itemcount">x 2</span>
			</div>
		</td>
	</tr>
</table>

<button id="export" class="btn" onclick="arm_down()">出庫</button>
<button id="import" class="btn" onclick="instorage()">入庫</button>

<div id="belt_div">
	<img id="arm" src="./images/arm.png" />
	<img id="target" src="./images/item/cpf.png" />
	<img id="belt" class="belt" src="./images/belt.png" style="float: left;" />
	<img id="belt2" class="belt" src="./images/belt.png" style="position: absolute; float: right; right: 4.5%;" />
</div>
<div id="track_div">
	<img src="./images/track.png" id="track" />
</div>
</div>
<script>
	
	setup();
	
	var is_export = false;
	var item_speed = 0;
	var belt_speed = 0;
	var itemName = 'cpf';
	
	var target = document.getElementById("target");
	var arm = document.getElementById("arm");
	
	document.getElementById("cpf").classList.add('itemclick');
	document.getElementById("import").style.display = 'none';
	
	// 出庫
	function arm_down() {
	
		is_export = true;
		document.getElementById("export").style.display = 'none';
		
		cpf_fun(itemName);
		start(true);
		
		minus(itemName);
		
		target.style.display = 'block';
		arm.style.display = 'block';
		var down = setInterval(downItem, 9);
		var downpos = 265;
		var outpos;
		var moveout;
		
		function downItem() {
			if(downpos <= 99) {
				clearInterval(down);
				arm.src = './images/arm.gif';
				outpos = downpos + 17;
				setTimeout(function(){
					moveout = setInterval(moveout, 5);
					outstorage();
				}, 1000);
			} else if(downpos <= 105) {
				downpos -= 0.1;
				target.style.bottom = downpos + '%';
				arm.style.bottom = downpos + 17 + '%';
			} else if(downpos <= 110) {
				downpos -= 0.2;
				target.style.bottom = downpos + '%';
				arm.style.bottom = downpos + 17 + '%';
			} else if(downpos <= 120) {
				downpos -= 0.3;
				target.style.bottom = downpos + '%';
				arm.style.bottom = downpos + 17 + '%';
			} else {
				downpos -= 1;
				target.style.bottom = downpos + '%';
				arm.style.bottom = downpos + 17 + '%';
			}
		}
		
		function moveout() {
			if(outpos >= 260) {
				clearInterval(moveout);
				arm.style.display = 'none';
				
			} else {
				outpos += 0.7;
				arm.style.bottom = outpos + '%';
			}
		}
	}

	function outstorage() {
		
		document.getElementById("belt").src="./images/belt_right.gif";
		document.getElementById("belt2").src="./images/belt_right.gif";
		
		var pos = 0.85;
		var downpos = 99;
		var move_out = setInterval(move_out, 5);
		
		function move_out() {
			if(pos >= 105) {
				clearInterval(move_out);
				document.getElementById("belt").src="./images/belt.png";
				document.getElementById("belt2").src="./images/belt.png";
				setTimeout(function(){
					if(cpf.get("a0") == 0) {
						document.getElementById("import").style.display = 'block';
					}
				}, 5000);
			} if(pos >= 92) {
				pos += item_speed;
				downpos -= 0.15;
				target.style.left = pos + '%';
				target.style.bottom = downpos + '%';
			}
			else {
				pos += item_speed;
				target.style.left = pos + '%';
			}
		}
		
		// Belt slide
		var beltpos = 10;
		var belt_moveR;
		setTimeout(function(){
			belt_moveR = setInterval(belt_moveR, 5);
		}, 1500);
		
		function belt_moveR() {
			if(beltpos <= -150) {
				clearInterval(belt_moveR);
			} else {
				beltpos -= belt_speed;
				document.getElementById("belt_div").style.left = beltpos + '%';
				document.getElementById("track").style.left = beltpos + 188 + '%';
			}
		}
		
	}

	// 入庫
	function instorage() {
		
		document.getElementById("import").style.display = 'none';
		
		start(false);
		item_speed = item_speed + 0.01;
		belt_speed = belt_speed + 0.01;
		
		minus();

		document.getElementById("belt").src="./images/belt_left.gif";
		document.getElementById("belt2").src="./images/belt_left.gif";
		
		var pos = 105;
		var downpos = 75;
		var move_in = setInterval(move_in, 5);
		
		function move_in() {
			if(pos <= 0.85) {
				clearInterval(move_in);
				document.getElementById("belt").src="./images/belt.png";
				document.getElementById("belt2").src="./images/belt.png";
				arm_up();
				setTimeout(export_btn(), 5000);
			} if(pos >= 92) {
				pos -= item_speed;
				target.style.left = pos + '%';
				downpos += 0.11;
				target.style.bottom = downpos + '%';
			} else {
				pos -= item_speed;
				target.style.left = pos + '%';
			}
		}
		
		function export_btn() {
			if(cpf.get("a0") == 0) {
				document.getElementById("export").style.display = 'block';
			} else {
				setTimeout(export_btn(), 5000);
			}
		}
		
		// Belt slide
		var beltpos = -150;
		var belt_moveL;
		
		setTimeout(function(){
			belt_moveL = setInterval(belt_moveL, 5);
		}, 500);
		
		function belt_moveL() {
			if(beltpos >= 10) {
				clearInterval(belt_moveL);
			} else {
				beltpos += belt_speed;
				document.getElementById("belt_div").style.left = beltpos + '%';
				document.getElementById("track").style.left = beltpos + 188 + '%';
			}
		}
	}
	
	function arm_up() {
		arm.src = './images/arm2.png';
		arm.style.display = 'block';
		var armDown = setInterval(armDown, 9);
		var downpos = 265;
		var outpos;
		var moveout;
		
		function armDown() {
			if(downpos <= 99) {
				clearInterval(armDown);
				arm.src = './images/arm2.gif';
				outpos = downpos;
				setTimeout(function(){
					moveout = setInterval(moveout, 5);
				}, 1000);
			} else {
				downpos -= 1;
				arm.style.bottom = downpos + 17 + '%';
			}
		}
		
		function moveout() {
			if(outpos >= 260) {
				clearInterval(moveout);
				arm.style.display = 'none';
				target.style.display = 'none';
			} else {
				outpos += 0.7;
				target.style.bottom = outpos + '%';
				arm.style.bottom = outpos + 17 + '%';
			}
		}
		
	}
	
	// CPF功能
	function cpf_fun(item) {
	
		var x;
		
		switch(item) {
			case 'cpf':
				x = Math.floor(Math.random() * 2);
				cpf_clear();
				// 4
				cpf.set("d4", 1);
				item_speed = 0.08;
				belt_speed = 0.13;
				break;
			case 'nb':
				x = Math.floor(Math.random() * 3);
				cpf_clear();
				if(x == 0) {
					// 6
					cpf.set("d3", 255);
					cpf.set("d4", 1);
					item_speed = 0.08;
					belt_speed = 0.13;
				} else if(x == 1) {
					// 9
					cpf.set("d2", 1);
					cpf.set("d5", 255);
					item_speed = 0.06;
					belt_speed = 0.09;	
				} else {
					// 24
					cpf.set("d4", 1);
					cpf.set("d9", 255);
					item_speed = 0.04;
					belt_speed = 0.07;
				}
				break;
			case 'lcd':
				x = Math.floor(Math.random() * 3);
				cpf_clear();
				if(x == 0) {
					// 1
					cpf.set("d2", 1);
					item_speed = 0.1;
					belt_speed = 0.15;	
				} else if (x == 1) {
					// 12
					cpf.set("d3", 255);
					cpf.set("d6", 255);
					item_speed = 0.04;
					belt_speed = 0.07;
				} else {
					// 21
					cpf.set("d2", 1);
					cpf.set("d9", 255);
					item_speed = 0.06;
					belt_speed = 0.09;	
				}
				break;
			case 'pc':
				x = Math.floor(Math.random() * 3);
				cpf_clear();
				if(x == 0) {
					// 7
					cpf.set("d2", 1);
					cpf.set("d3", 255);
					cpf.set("d4", 1);		
					item_speed = 0.06;
					belt_speed = 0.09;
				} else if(x == 1) {
					// 22
					cpf.set("d3", 255);
					cpf.set("d9", 255);
					item_speed = 0.04;
					belt_speed = 0.07;
				} else {
					// 18
					cpf.set("d5", 255);
					cpf.set("d6", 255);
					item_speed = 0.08;
					belt_speed = 0.13;
				}
				break;
			case 'pj':
				x = Math.floor(Math.random() * 2);
				cpf_clear();
				if(x == 0) {
					// 3
					cpf.set("d2", 1);
					cpf.set("d3", 255);
					item_speed = 0.08;
					belt_speed = 0.13;	
				} else {
					// 15
					cpf.set("d2", 1);
					cpf.set("d4", 1);
					cpf.set("d6", 255);
					item_speed = 0.08;
					belt_speed = 0.13;	
				}
				break;
			case 'abs':
				cpf_clear();
				// 10
				cpf.set("d6", 255);
				item_speed = 0.04;
				belt_speed = 0.07;
				break;
			case 'egg':
				x = Math.floor(Math.random() * 3);
				cpf_clear();
				if(x == 0) {
					// 13 (George)
					cpf.set("d2", 1);
					cpf.set("d3", 255);
					cpf.set("d6", 255);
					item_speed = 0.1;
					belt_speed = 0.15;	
				} else if(x == 1) {
					// 16 (牛)
					cpf.set("d3", 255);
					cpf.set("d4", 1);
					cpf.set("d6", 255);
					item_speed = 0.08;
					belt_speed = 0.13;	
				} else {
					// 19 (Stan)
					cpf.set("d2", 1);
					cpf.set("d5", 255);
					cpf.set("d6", 255);
					item_speed = 0.06;
					belt_speed = 0.09;	
				}
				break;
			default:
				// 4
				cpf.set("d4", 1);
				item_speed = 0.08;
				belt_speed = 0.13;
				break;
		}
	}
	
	function cpf_clear() {
		cpf.set("d2", 0);
		cpf.set("d3", 0);
		cpf.set("d4", 0);
		cpf.set("d5", 0);
		cpf.set("d6", 0);
		cpf.set("d9", 0);
	}
	
	function start(flag) {
		if(flag) {
			cpf.set("d10", 255);
		} else {
			cpf.set("d10", 0);
		}	
		
		setTimeout(function(){
			cpf.set("d11", 255);
			cpf.set("d11", 0);
		},1000);
	}
	
	function minus(name){
		if(name == 'cpf') {
			document.getElementById(name + "_count").innerHTML = 'x 0';
		} else if(name == 'nb') {
			document.getElementById(name + "_count").innerHTML = 'x 2';
		} else if(name == 'lcd') {
			document.getElementById(name + "_count").innerHTML = 'x 2';
		} else if(name == 'pc') {
			document.getElementById(name + "_count").innerHTML = 'x 2';
		} else if(name == 'pj') {
			document.getElementById(name + "_count").innerHTML = 'x 1';
		} else if(name == 'abs') {
			document.getElementById(name + "_count").innerHTML = 'x 0';
		} else if(name == 'egg') {
			document.getElementById(name + "_count").innerHTML = 'x 2';
		} else {
			document.getElementById("cpf_count").innerHTML = 'x 1';
			document.getElementById("nb_count").innerHTML = 'x 3';
			document.getElementById("lcd_count").innerHTML = 'x 3';
			document.getElementById("pc_count").innerHTML = 'x 3';
			document.getElementById("pj_count").innerHTML = 'x 2';
			document.getElementById("abs_count").innerHTML = 'x 1';
			document.getElementById("egg_count").innerHTML = 'x 3';
		}
	}
	
	// 商品選擇
	function changeItem(name, node) {
		
		if(is_export) return;
		
		itemName = name;
		
		document.getElementById("target").src= './images/item/' + name + '.png';
		
		var parent = document.getElementById("parent").childNodes;
		if(parent[node].nodeName != 'DIV') {
			alert('errNode');
		} else {
			for(var i = 1; i <= 13; i+=2) {
				parent[i].classList.remove('itemclick');
			}
			parent[node].classList.add('itemclick');
		}
		
		if (name == 'laptop') {
			//document.getElementById("target").style.width = '7.9%';
			//document.getElementById("target").style.left = '0.2%';
		} 
	}
	
	// cpf setup
	function setup(){
		if(cpf)
			var ret = cpf.setPinMode('["resetPin"],["setPinMode", "analog", 0, "INPUT"],["setPinMode", "digital", 2, "OUTPUT"],["setPinMode", "digital", 3, "PWM"],["setPinMode", "digital", 4, "OUTPUT"],["setPinMode", "digital", 5, "PWM"],["setPinMode", "digital", 6, "PWM"],["setPinMode", "digital", 9, "PWM"],["setPinMode", "digital", 10, "PWM"],["setPinMode", "digital", 11, "PWM"],["setPinMode", "digital", 12, "OUTPUT"]');
		
	}

</script>

</body>
</html>